<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>OASIS Advanced Message Queuing Protocol (AMQP) Version 1.0, Part 4: Transactions</title><style type="text/css">
            body {
            margin: 2em;
            padding: 1em;
            font-size: 10.0pt;
            font-family: "DejaVu LGC Sans", "Bitstream Vera Sans", arial, helvetica, sans-serif;
            }
h1
	{margin-top:24.0pt;
	margin-right:0in;
	margin-bottom:6.0pt;
	margin-left:.3in;
	text-indent:-.3in;
	page-break-before:always;
	page-break-after:avoid;
	text-autospace:ideograph-other;
	border:none;
	padding:0in;
	font-size:13.0pt;
	font-family:"Arial","sans-serif";
	color:#3B006F;
	font-weight:bold;}
h2
	{margin-top:12.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.4in;
	margin-bottom:.0001pt;
	text-indent:-.4in;
	page-break-after:avoid;
	text-autospace:ideograph-other;
	font-size:12.0pt;
	font-family:"Arial","sans-serif";
	color:#3B006F;
	font-weight:bold;}
h3
	{margin-top:12.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.5in;
	margin-bottom:.0001pt;
	text-indent:-.5in;
	page-break-after:avoid;
	text-autospace:ideograph-other;
	font-size:11.0pt;
	font-family:"Arial","sans-serif";
	color:#3B006F;
	font-weight:bold;}
h4
	{margin-top:12.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.6in;
	margin-bottom:.0001pt;
	text-indent:-.6in;
	page-break-after:avoid;
	text-autospace:ideograph-other;
	font-size:10.0pt;
	font-family:"Arial","sans-serif";
	color:#3B006F;
	font-weight:bold;}
h5
	{margin-top:12.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.7in;
	margin-bottom:.0001pt;
	text-indent:-.7in;
	page-break-after:avoid;
	text-autospace:ideograph-other;
	font-size:10.0pt;
	font-family:"Arial","sans-serif";
	color:#3B006F;
	font-weight:bold;}
h6
	{margin-top:12.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.8in;
	margin-bottom:.0001pt;
	text-indent:-.8in;
	page-break-after:avoid;
	text-autospace:ideograph-other;
	font-size:9.0pt;
	font-family:"Arial","sans-serif";
	color:#3B006F;
	font-weight:bold;}
                  
            h1 a, h2 a, h3 a, h4 a {
            color: #3B006F
            }
      
            a {
            text-decoration: none;
            color: #66f;
            }
            
            a.anchor {
            color: #000;
            }
            
            a.toc {
            float: right;
            }
            
            table {
            border-collapse: collapse;
            margin: 1em 1em;
            }
            
            dt {
            font-weight: bold;
            }
            
            dt:after {
            content: ":";
            }
            
            div.toc {
            border: 1px solid #ccc;
            padding: 1em;
            }
            
            table.toc {
            margin: 0;
            }
            
            table.pre {
            background: #eee;
            border: 1px solid #ccc;
            margin-left: auto;
            margin-right: auto;
            }
            
            table.pre td {
            font-family: Courier, monospace;
            font-size:10.0pt;
            white-space: pre;
            padding: 0em 2em;
            }
            
            table.definition {
            width: 100%;
            }
            
            table.signature {
            background: #eee;
            border: 1px solid #ccc;
            width: 100%;
            }
            
            table.signature td {
            font-family: monospace;
            font-size:9.0pt;
            white-space: pre;
            padding: 1em;
            }

            table.encodings th {
            font-size:10.0pt;
            padding: 2px 2em;
            border-bottom-style:solid;
            border-bottom-width:2px;
            text-align:left;
            }

            table.encodings td {
            font-size:10.0pt;
            padding: 2px 2em;
            }
            
            table.constants td {
            font-size:10.0pt;
            padding: 2px 1em;
            }

            table.composite {
            width: 100%;
            }
            
            td.field {
            padding: 0.5em 2em;
            }
            
            div.section {
            padding: 0 0 0 1em;
            }
            
            div.doc {
            padding: 0 0 1em 0;
            }
            
            table.composite div.doc {
            padding: 0;
            }
            
            table.error {
            width: 100%;
            margin: 0;
            }
            
            table.error tr:last-child td {
            padding: 0 0 0 1em;
            }
            
            .todo:before {
            content: "TODO: ";
            font-weight: bold;
            color: red;
            }
            
            .todo {
            font-variant: small-caps;
            font-weight: bold;
            color: red;
            }

p.OasisTitle
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:12.0pt;
	margin-left:0in;
	text-autospace:ideograph-other;
	border:none;
	padding:0in;
	font-size:24.0pt;
	font-family:"Arial","sans-serif";
	color:#3B006F;
	font-weight:bold;}

p.OasisContributor
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.5in;
	margin-bottom:.0001pt;
	text-autospace:ideograph-other;
	font-size:10.0pt;
	font-family:"Arial","sans-serif";}
a:link, span.OasisHyperlink
	{color:#0000EE;
	text-decoration:none;}
a:visited, span.OasisHyperlinkFollowed
	{color:purple;
	text-decoration:underline;}

p.OasisSubtitle
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:12.0pt;
	margin-left:0in;
	text-autospace:ideograph-other;
	border:none;
	padding:0in;
	font-size:18.0pt;
	font-family:"Arial","sans-serif";
	color:#3B006F;
	font-weight:bold;}
p.OasisTitlePageInfo
	{margin-top:4.3pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:0in;
	margin-bottom:.0001pt;
	page-break-after:avoid;
	text-autospace:ideograph-other;
	font-size:10.0pt;
	font-family:"Arial","sans-serif";
	color:#3B006F;
	font-weight:bold;}
p.OasisTitlePageInfoDescription
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:4.3pt;
	margin-left:.5in;
	text-autospace:ideograph-other;
	font-size:10.0pt;
	font-family:"Arial","sans-serif";}

        table.RevisionHistory {
            width: 650px;
            }
        table.RevisionHistory th {
            font-size:11.0pt;
            padding: 2px;
            padding-below: 4px;
            color:#3B006F;
            text-align:left;
            font-weight:bold;}
        table.RevisionHistory td.issue {
            width:6em;
            padding-left: 1em;
            vertical-align: top;
            text-align: right}
</style></head><body><img width="203" height="54" src="oasis.jpg"><hr><p class="OasisTitle">OASIS Advanced Message Queuing Protocol (AMQP) Version 1.0<br>
        Part 4: Transactions</p><p class="OasisSubtitle">OASIS Standard</p><p class="OasisSubtitle">29 October 2012</p><p class="OasisTitlePageInfo"><span style="font-size:12.0pt">Specification URIs</span></p><p class="OasisTitlePageInfo">This version:</p><p class="OasisTitlePageInfoDescription" style="margin-bottom:0in;margin-bottom:.0001pt"><a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transactions-v1.0-os.xml">http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transactions-v1.0-os.xml</a> (Authoritative)</p><p class="OasisTitlePageInfoDescription" style="margin-bottom:0in;margin-bottom:.0001pt"><a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transactions-v1.0-os.html">http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transactions-v1.0-os.html</a></p><p class="OasisTitlePageInfoDescription" style="margin-bottom:0in;margin-bottom:.0001pt"><a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-complete-v1.0-os.pdf">http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-complete-v1.0-os.pdf</a></p><p class="OasisTitlePageInfo">Previous version:</p><p class="OasisTitlePageInfoDescription" style="margin-bottom:0in;margin-bottom:.0001pt"><a href="http://docs.oasis-open.org/amqp/core/v1.0/csprd01/amqp-core-transactions-v1.0-csprd01.xml">http://docs.oasis-open.org/amqp/core/v1.0/csprd01/amqp-core-transactions-v1.0-csprd01.xml</a> (Authoritative)</p><p class="OasisTitlePageInfoDescription" style="margin-bottom:0in;margin-bottom:.0001pt"><a href="http://docs.oasis-open.org/amqp/core/v1.0/csprd01/amqp-core-transactions-v1.0-csprd01.html">http://docs.oasis-open.org/amqp/core/v1.0/csprd01/amqp-core-transactions-v1.0-csprd01.html</a></p><p class="OasisTitlePageInfoDescription" style="margin-bottom:0in;margin-bottom:.0001pt"><a href="http://docs.oasis-open.org/amqp/core/v1.0/csprd01/amqp-core-complete-v1.0-csprd01.pdf">http://docs.oasis-open.org/amqp/core/v1.0/csprd01/amqp-core-complete-v1.0-csprd01.pdf</a></p><p class="OasisTitlePageInfo">Latest version:</p><p class="OasisTitlePageInfoDescription" style="margin-bottom:0in;margin-bottom:.0001pt"><a href="http://docs.oasis-open.org/amqp/core/v1.0/amqp-core-transactions-v1.0.xml">http://docs.oasis-open.org/amqp/core/v1.0/amqp-core-transactions-v1.0.xml</a> (Authoritative)</p><p class="OasisTitlePageInfoDescription" style="margin-bottom:0in;margin-bottom:.0001pt"><a href="http://docs.oasis-open.org/amqp/core/v1.0/amqp-core-transactions-v1.0.html">http://docs.oasis-open.org/amqp/core/v1.0/amqp-core-transactions-v1.0.html</a></p><p class="OasisTitlePageInfoDescription" style="margin-bottom:0in;margin-bottom:.0001pt"><a href="http://docs.oasis-open.org/amqp/core/v1.0/amqp-core-complete-v1.0.pdf">http://docs.oasis-open.org/amqp/core/v1.0/amqp-core-complete-v1.0.pdf</a></p><p class="OasisTitlePageInfo">Technical Committee:</p><p class="OasisTitlePageInfoDescription" style="margin-bottom:0in;margin-bottom:.0001pt"><a href="http://www.oasis-open.org/committees/amqp/">OASIS Advanced Message Queuing Protocol (AMQP) TC</a></p><p class="OasisTitlePageInfo">Chairs:</p>
  <p class="OasisContributor">Ram Jeyaraman (<span class="OasisHyperlink"><a href="mailto:Ram.Jeyaraman@microsoft.com">Ram.Jeyaraman@microsoft.com</a></span>),
<span class="OasisHyperlink"><a href="http://www.microsoft.com">Microsoft</a></span></p>
  <p class="OasisContributor">Angus Telfer (<span class="OasisHyperlink"><a href="mailto:angus.telfer@inetco.com">angus.telfer@inetco.com</a></span>),
<span class="OasisHyperlink"><a href="http://www.inetco.com">INETCO Systems</a></span></p>
<p class="OasisTitlePageInfo">Editors:</p>
  <p class="OasisContributor">Robert Godfrey (<span class="OasisHyperlink"><a href="mailto:robert.godfrey@jpmorgan.com">robert.godfrey@jpmorgan.com</a></span>),
<span class="OasisHyperlink"><a href="http://www.jpmorganchase.com">JPMorgan Chase &amp; Co.</a></span></p>
  <p class="OasisContributor">David Ingham (<span class="OasisHyperlink"><a href="mailto:David.Ingham@microsoft.com">David.Ingham@microsoft.com</a></span>),
<span class="OasisHyperlink"><a href="http://www.microsoft.com">Microsoft</a></span></p>
  <p class="OasisContributor">Rafael Schloming (<span class="OasisHyperlink"><a href="mailto:rafaels@redhat.com">rafaels@redhat.com</a></span>),
<span class="OasisHyperlink"><a href="http://www.redhat.com">Red Hat</a></span></p>
<p class="OasisTitlePageInfo">Additional artifacts:</p><p class="OasisTitlePageInfoDescription" style="margin-bottom:0in;margin-bottom:.0001pt">This specification consists of the following documents:</p><p class="OasisTitlePageInfoDescription" style="margin-bottom:0in;margin-bottom:.0001pt"><span style="font-family:Symbol">·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="OasisHyperLink"><a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-overview-v1.0-os.html#toc">Part 0: Overview</a></span> - Overview of the AMQP specification</p><p class="OasisTitlePageInfoDescription" style="margin-bottom:0in;margin-bottom:.0001pt"><span style="font-family:Symbol">·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="OasisHyperLink"><a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-types-v1.0-os.html#toc">Part 1: Types</a></span> - AMQP type system and encoding</p><p class="OasisTitlePageInfoDescription" style="margin-bottom:0in;margin-bottom:.0001pt"><span style="font-family:Symbol">·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="OasisHyperLink"><a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#toc">Part 2: Transport</a></span> - AMQP transport layer</p><p class="OasisTitlePageInfoDescription" style="margin-bottom:0in;margin-bottom:.0001pt"><span style="font-family:Symbol">·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="OasisHyperLink"><a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-messaging-v1.0-os.html#toc">Part 3: Messaging</a></span> - AMQP Messaging Layer</p><p class="OasisTitlePageInfoDescription" style="margin-bottom:0in;margin-bottom:.0001pt"><span style="font-family:Symbol">·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="OasisHyperLink"><a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transactions-v1.0-os.html#toc">Part 4: Transactions</a></span> (this document) - AMQP Transactions Layer</p><p class="OasisTitlePageInfoDescription" style="margin-bottom:0in;margin-bottom:.0001pt"><span style="font-family:Symbol">·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="OasisHyperLink"><a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-security-v1.0-os.html#toc">Part 5: Security</a></span> - AMQP Security Layers</p><p class="OasisTitlePageInfoDescription" style="margin-bottom:0in;margin-bottom:.0001pt"><span style="font-family:Symbol">·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="OasisHyperLink"><a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp.dtd">XML Document Type Definition (DTD)</a></span></p><p class="OasisTitlePageInfo">Related work:</p><p class="OasisTitlePageInfoDescription" style="margin-bottom:0in;margin-bottom:.0001pt">This specification replaces or supersedes:</p><p class="OasisTitlePageInfoDescription" style="margin-bottom:0in;margin-bottom:.0001pt"><span style="font-family:Symbol">·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span>AMQP v1.0 Final, 07 October 2011. <span class="OasisHyperLink"><a href="http://www.amqp.org/specification/1.0/amqp-org-download">http://www.amqp.org/specification/1.0/amqp-org-download</a></span></p><p class="OasisTitlePageInfo">Abstract:</p>
<p class="OasisTitlePageInfoDescription">The Advanced Message Queuing Protocol (AMQP) is an open internet protocol for business
    messaging. It defines a binary wire-level protocol that allows for the reliable exchange
    of business messages between two parties.
    AMQP has a layered architecture and the specification is organized as a set of parts that
    reflects that architecture. Part 1 defines the AMQP type system and encoding. Part 2 defines
    the AMQP transport layer, an efficient, binary, peer-to-peer protocol for transporting messages
    between two processes over a network. Part 3 defines the AMQP message format, with a
    concrete encoding. Part 4 defines how interactions can be grouped within atomic
    transactions. Part 5 defines the AMQP security layers.</p>
<p class="OasisTitlePageInfo">Status:</p><p class="OasisTitlePageInfoDescription">
This document was last revised or approved by the membership of OASIS on the above date. The level of approval is also listed above. Check the "Latest version" location noted above for possible later revisions of this document.
</p><p class="OasisTitlePageInfoDescription">
Technical Committee members should send comments on this specification to the Technical Committee's email list. Others should send comments to the Technical Committee by using the "<a href="http://www.oasis-open.org/committees/comments/index.php?wg_abbrev=amqp">Send A Comment</a>" button on the Technical Committee's web page at <a href="http://www.oasis-open.org/committees/amqp/">http://www.oasis-open.org/committees/comments/amqp/</a>.
</p><p class="OasisTitlePageInfoDescription">For information on whether any patents have been disclosed that may be essential to implementing this specification, and any offers of patent licensing terms, please refer to the Intellectual Property Rights section of the Technical Committee web page (<a href="http://www.oasis-open.org/committees/amqp/ipr.php">http://www.oasis-open.org/committees/amqp/ipr.php</a>).
</p><p class="OasisTitlePageInfo">Citation format:</p><p class="OasisTitlePageInfoDescription">When referencing this specification the
following citation format should be used:</p><p class="OasisTitlePageInfoDescription"><b><span style="color:black">[amqp-core-transactions-v1.0]</span></b></p><p class="OasisTitlePageInfoDescription"><i><span style="color:black">OASIS Advanced Message Queuing Protocol (AMQP) Version 1.0 Part 4: Transactions</span></i><span style="color:black">.
29 October 2012. OASIS Standard. </span><span class="OasisHyperlink"><a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transactions-v1.0-os.html">http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transactions-v1.0-os.html</a></span><span style="color:black">.</span></p><hr><p class="OasisTitlePageInfo"><span style="font-size:12.0pt">Notices</span></p>
<p class="OasisTitlePageInfoDescription">
  Copyright &copy; OASIS Open 2012. All Rights Reserved.
</p>
<p class="OasisTitlePageInfoDescription">
  All capitalized terms in the following text have the meanings assigned to them in the OASIS
  Intellectual Property Rights Policy (the "OASIS IPR Policy"). The full <a href="http://www.oasis-open.org/policies-guidelines/ipr">Policy</a> may be found at the
  OASIS website.
</p>
<p class="OasisTitlePageInfoDescription">
  This document and translations of it may be copied and furnished to others, and derivative works
  that comment on or otherwise explain it or assist in its implementation may be prepared, copied,
  published, and distributed, in whole or in part, without restriction of any kind, provided that
  the above copyright notice and this section are included on all such copies and derivative works.
  However, this document itself may not be modified in any way, including by removing the copyright
  notice or references to OASIS, except as needed for the purpose of developing any document or
  deliverable produced by an OASIS Technical Committee (in which case the rules applicable to
  copyrights, as set forth in the OASIS IPR Policy, must be followed) or as required to translate
  it into languages other than English.
</p>
<p class="OasisTitlePageInfoDescription">
  The limited permissions granted above are perpetual and will not be revoked by OASIS or its
  successors or assigns.
</p>
<p class="OasisTitlePageInfoDescription">
  This document and the information contained herein is provided on an "AS IS" basis and OASIS
  DISCLAIMS ALL WARRANTIES, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTY THAT THE
  USE OF THE INFORMATION HEREIN WILL NOT INFRINGE ANY OWNERSHIP RIGHTS OR ANY IMPLIED WARRANTIES OF
  MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
</p>
<p class="OasisTitlePageInfoDescription">
  OASIS requests that any OASIS Party or any other party that believes it has patent claims that
  would necessarily be infringed by implementations of this OASIS Committee Specification or OASIS
  Standard, to notify OASIS TC Administrator and provide an indication of its willingness to grant
  patent licenses to such patent claims in a manner consistent with the IPR Mode of the OASIS
  Technical Committee that produced this specification.
</p>
<p class="OasisTitlePageInfoDescription">
  OASIS invites any party to contact the OASIS TC Administrator if it is aware of a claim of
  ownership of any patent claims that would necessarily be infringed by implementations of this
  specification by a patent holder that is not willing to provide a license to such patent claims in
  a manner consistent with the IPR Mode of the OASIS Technical Committee that produced this
  specification. OASIS may include such claims on its website, but disclaims any obligation to do
  so.
</p>
<p class="OasisTitlePageInfoDescription">
  OASIS takes no position regarding the validity or scope of any intellectual property or other
  rights that might be claimed to pertain to the implementation or use of the technology described
  in this document or the extent to which any license under such rights might or might not be
  available; neither does it represent that it has made any effort to identify any such rights.
  Information on OASIS' procedures with respect to rights in any document or deliverable produced
  by an OASIS Technical Committee can be found on the OASIS website. Copies of claims of rights
  made available for publication and any assurances of licenses to be made available, or the result
  of an attempt made to obtain a general license or permission for the use of such proprietary
  rights by implementers or users of this OASIS Committee Specification or OASIS Standard, can be
  obtained from the OASIS TC Administrator. OASIS makes no representation that any information or
  list of intellectual property rights will at any time be complete, or that any claims in such list
  are, in fact, Essential Claims.
</p>
<p class="OasisTitlePageInfoDescription">
  The name "OASIS" is a trademark of <a href="http://www.oasis-open.org/">OASIS</a>, the owner and developer of this specification, and
  should be used only to refer to the organization and its official outputs. OASIS welcomes
  reference to, and implementation and use of, specifications, while reserving the right to enforce
  its marks against misleading uses. Please see <a href="http://www.oasis-open.org/policies-guidelines/trademark">http://www.oasis-open.org/policies-guidelines/trademark</a> for above guidance.
</p>
<hr><h2><a name="toc">Table of Contents</a></h2><br><br><table class="toc" summary="Table of Contents">

  

  <tr><td>4.1 <a href="#section-transactions">Transactional Messaging</a></td></tr>

  <tr><td>4.2 <a href="#section-txn-declare">Declaring a Transaction</a></td></tr>

  <tr><td>4.3 <a href="#section-txn-discharge">Discharging a Transaction</a></td></tr>

  <tr><td>4.4 <a href="#section-txn-work">Transactional Work</a></td></tr><tr><td>      4.4.1 <a href="#doc-idp111808">Transactional Posting</a></td></tr><tr><td>      4.4.2 <a href="#doc-idp120240">Transactional Retirement</a></td></tr><tr><td>      4.4.3 <a href="#doc-idp130640">Transactional Acquisition</a></td></tr><tr><td>      4.4.4 <a href="#doc-idp145616">Interaction of Settlement with Transactions</a></td></tr>

  <tr><td>4.5 <a href="#section-coordination">Coordination</a></td></tr><tr><td>      4.5.1 <a href="#type-coordinator">Coordinator</a></td></tr><tr><td>      4.5.2 <a href="#type-declare">Declare</a></td></tr><tr><td>      4.5.3 <a href="#type-discharge">Discharge</a></td></tr><tr><td>      4.5.4 <a href="#type-transaction-id">Transaction Id</a></td></tr><tr><td>      4.5.5 <a href="#type-declared">Declared</a></td></tr><tr><td>      4.5.6 <a href="#type-transactional-state">Transactional State</a></td></tr><tr><td>      4.5.7 <a href="#type-txn-capability">Txn Capability</a></td></tr><tr><td>      4.5.8 <a href="#type-transaction-error">Transaction Error</a></td></tr>

</table><hr>

  

  <h2><a class="toc" href="#toc">←</a>4.1 <a name="section-transactions">Transactional Messaging</a></h2><div class="section"><div class="doc"><p>
        Transactional messaging allows for the coordinated outcome of otherwise independent
        transfers. This extends to an arbitrary number of transfers spread across any number of
        distinct links in either direction.
      </p><p>
        For every transactional interaction, one container acts as the <i>transactional
        resource</i>, and the other container acts as the <i>transaction controller</i>.
        The <i>transactional resource</i> performs <i>transactional work</i> as requested by
        the <i>transaction controller</i>.
      </p><p>
        The <i>transactional controller</i> and <i>transactional resource</i> communicate over a
        <i>control link</i> which is established by the <i>transactional controller</i>. The <a href="#type-declare">declare</a> and <a href="#type-discharge">discharge</a> messages are sent by the <i>transactional
        controller</i> over the <i>control link</i> to allocate and complete transactions
        respectively (they do not represent the demarcation of transactional work). No transactional
        work is allowed on the <i>control link</i>. Each transactional operation requested is
        explicitly identified with the desired transaction-id and therefore can occur on any link
        within the controlling session, or, if permitted by the capabilities of the controller, any
        link on the controlling connection. If the <i>control link</i> is closed while there exist
        non-discharged transactions it created, then all such transactions are immediately rolled
        back, and attempts to perform further transactional work on them will lead to failure.
      </p></div></div>

  <h2><a class="toc" href="#toc">←</a>4.2 <a name="section-txn-declare">Declaring a Transaction</a></h2><div class="section"><div class="doc"><p>
        The container acting as the transactional resource defines a special target that functions
        as a <a href="#type-coordinator" title="coordinator">transaction coordinator</a>. The <i>transaction
        controller</i> establishes a control link to this target. Note that links to the <a href="#type-coordinator">coordinator</a> cannot be resumed.
      </p><p>
        To begin transactional work, the transaction controller needs to obtain a transaction
        identifier from the resource. It does this by sending a message to the <a href="#type-coordinator">coordinator</a> whose body consists of the <a href="#type-declare">declare</a> type in a single
        <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-messaging-v1.0-os.html#type-amqp-value">amqp-value</a> section. Other standard message sections such as the
        header section SHOULD be ignored. This message MUST NOT be sent settled as the sender is
        REQUIRED to receive and interpret the outcome of the declare from the receiver. If the
        coordinator receives a <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-transfer">transfer</a> that has been settled by the
        sender, it SHOULD <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-detach">detach</a> with an amqp:illegal-state error.
      </p><p>
        If the declaration is successful, the coordinator responds with a disposition outcome of
        <a href="#type-declared">declared</a> which carries the assigned identifier for the transaction.
      </p><p>
        If the coordinator was unable to perform the <a href="#type-declare">declare</a> as specified by
        the transaction controller, the transaction coordinator MUST convey the error to the
        controller as a <a href="#type-transaction-error">transaction-error</a>. If the <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-messaging-v1.0-os.html#type-source">source</a> for the link
        to the <a href="#type-coordinator">coordinator</a> supports the <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-messaging-v1.0-os.html#type-rejected">rejected</a> outcome, then the
        message MUST be <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-messaging-v1.0-os.html#type-rejected">rejected</a> with this outcome carrying the <a href="#type-transaction-error">transaction-error</a>. If the <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-messaging-v1.0-os.html#type-source">source</a> does not support the <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-messaging-v1.0-os.html#type-rejected">rejected</a> outcome, the <i>transactional resource</i> MUST <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-detach">detach</a> the
        link to the coordinator, with the <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-detach">detach</a> performative carrying the <a href="#type-transaction-error">transaction-error</a>.
      </p><p>
        Transaction controllers SHOULD establish a control link that allows the
        <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-messaging-v1.0-os.html#type-rejected">rejected</a> outcome.
      </p><table class="pre" summary="Declaring a Transaction"><caption style="caption-side:bottom">Figure 4.1: Declaring a Transaction</caption><tr><td>
Transaction Controller                  Transactional Resource
===============================================================================

ATTACH(name=txn-ctl,          ---------&gt;
       ...,
       target=
         Coordinator(
           capabilities=
             "amqp:local-transactions")
      )

                             &lt;--------- ATTACH(name=txn-ctl,
                                               ...,
                                               target=
                                                 Coordinator(
                                                   capabilities=
                                                     ["amqp:local-transactions",
                                                      "amqp:multi-txns-per-ssn"]
                                                            )
                                              )

                             &lt;--------- FLOW(...,handle=1, link-credit=1)

TRANSFER(delivery-id=0, ...) ---------&gt;
{ AmqpValue( Declare() ) }

                             &lt;--------- DISPOSITION(first=0, last=0,
                                                    state=Declared(txn-id=0) )

-------------------------------------------------------------------------------

      </td></tr></table></div></div>

  <h2><a class="toc" href="#toc">←</a>4.3 <a name="section-txn-discharge">Discharging a Transaction</a></h2><div class="section"><div class="doc"><p>
        The controller will conclude the transactional work by sending a <a href="#type-discharge">discharge</a>
        message (encoded in a single <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-messaging-v1.0-os.html#type-amqp-value">amqp-value</a> section) to the
        coordinator. The controller indicates that it wishes to commit or rollback the transactional
        work by setting the <i>fail</i> flag on the <a href="#type-discharge">discharge</a> body. As with the <a href="#type-declare">declare</a> message, it is an error if the sender sends the <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-transfer">transfer</a> pre-settled.
      </p><p>
        If the coordinator is unable to complete the <a href="#type-discharge">discharge</a>, the coordinator
        MUST convey the error to the controller as a <a href="#type-transaction-error">transaction-error</a>. If the <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-messaging-v1.0-os.html#type-source">source</a> for the link to the <a href="#type-coordinator">coordinator</a> supports the
        <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-messaging-v1.0-os.html#type-rejected">rejected</a> outcome, then the message MUST be <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-messaging-v1.0-os.html#type-rejected">rejected</a> with this outcome carrying the <a href="#type-transaction-error">transaction-error</a>. If the
        <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-messaging-v1.0-os.html#type-source">source</a> does not support the <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-messaging-v1.0-os.html#type-rejected">rejected</a>
        outcome, the <i>transactional resource</i> MUST <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-detach">detach</a> the link
        to the coordinator, with the <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-detach">detach</a> performative carrying the
        <a href="#type-transaction-error">transaction-error</a>. Note that the coordinator MUST always be able to complete
        a <a href="#type-discharge">discharge</a> where the fail flag is set to true (since coordinator failure
        leads to rollback, which is what the controller is asking for).
      </p><table class="pre" summary="Discharging a Transaction"><caption style="caption-side:bottom">Figure 4.2: Discharging a Transaction</caption><tr><td>
Transaction Controller                  Transactional Resource
===============================================================================

TRANSFER(delivery-id=0, ...) ---------&gt;
{ AmqpValue( Declare() ) }

                             &lt;--------- DISPOSITION(first=0, last=0,
                                                    state=Declared(txn-id=0) )

                                  :
                          Transactional Work
                                  :


TRANSFER(delivery-id=57, ...) ---------&gt;
{ AmqpValue(
    Discharge(txn-id=0,
              fail=false)
           ) }

                             &lt;--------- DISPOSITION(first=57, last=57,
                                                    state=Accepted() )

-------------------------------------------------------------------------------

      </td></tr></table></div></div>

  <h2><a class="toc" href="#toc">←</a>4.4 <a name="section-txn-work">Transactional Work</a></h2><div class="section"><div class="doc"><p>
        Transactional work is described in terms of the message states defined in <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-messaging-v1.0-os.html#section-distribution-nodes" title="distribution-nodes">section 3.3</a>. Transactional work is formally defined to be
        composed of the following operations:
      </p><ul>
        <li>
          <p><i>posting</i> a message at a target, i.e., making it <i>available</i></p>
        </li>
        <li>
          <p><i>acquiring</i> a message at a source, i.e., transitioning it to <i>acquired</i></p>
        </li>
        <li>
          <p><i>retiring</i> a message at a source, i.e., applying the terminal outcome</p>
        </li>
      </ul><p>
        The transactional resource performs these operations when triggered by the transaction
        controller:
      </p><ul>
        <li>
          <p>
            <i>posting</i> messages is initiated by incoming <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-transfer">transfer</a>
            frames
          </p>
        </li>
        <li>
          <p>
            <i>acquiring</i> messages is initiated by incoming <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-flow">flow</a>
            frames
          </p>
        </li>
        <li>
          <p>
            <i>retiring</i> messages is initiated by incoming <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-disposition">disposition</a>
            frames
          </p>
        </li>
      </ul><p>
        In each case, it is the responsibility of the transaction controller to identify the
        transaction with which the requested work is to be associated. This is done with the
        transactional delivery state <a href="#type-transactional-state">transactional-state</a> that combines a txn-id
        together with one of the terminal delivery states defined in <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-messaging-v1.0-os.html#section-delivery-state" title="delivery-state">section 3.4</a>. The <a href="#type-transactional-state">transactional-state</a> is carried by both the <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-transfer">transfer</a> and the <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-disposition">disposition</a> frames allowing
        both the <i>posting</i> and <i>retiring</i> of messages to be associated with a transaction.
      </p><p>
        The <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-transfer">transfer</a>, <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-disposition">disposition</a>, and <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-flow">flow</a> frames can travel in either direction, i.e., from the controller
        to the resource and from the resource to the controller. When these frames travel from the
        controller to the resource, any embedded txn-ids are requesting that the resource assigns
        transactional work to the indicated transaction. When traveling in the other direction, from
        resource to controller, the <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-transfer">transfer</a> and <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-disposition">disposition</a> frames indicate work performed, and the txn-ids included MUST correctly
        indicate with which (if any) transaction this work is associated. In the case of the <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-flow">flow</a> frame traveling from resource to controller, the txn-id does not
        indicate work that has been performed, but indicates with which transaction future transfers
        from that link will be performed.
      </p></div><h3><a class="toc" href="#toc">←</a>4.4.1 <a name="doc-idp111808">Transactional Posting</a></h3><div class="doc"><p>
        If the transaction controller wishes to associate an outgoing <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-transfer">transfer</a> with a
        transaction, it MUST set the state of the transfer with a <a href="#type-transactional-state">transactional-state</a>
        carrying the appropriate transaction identifier. Note that if delivery is split across
        several <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-transfer">transfer</a> frames then all frames MUST be explicitly associated with
        the same transaction. It is an error for the controller to attempt to discharge a
        transaction against which a partial delivery has been posted. If this happens, the
        control link MUST be terminated with the <a href="#choice-transaction-error-transaction-rollback">transaction-rollback</a> error.
      </p><p>
        The effect of transactional posting is that the message does not become available at the
        destination node within the transactional resource until after the transaction has been
        successfully discharged.
      </p><table class="pre" summary="Transactional Publish"><caption style="caption-side:bottom">Figure 4.3: Transactional Publish</caption><tr><td>
Transaction Controller                  Transactional Resource
===============================================================================

TRANSFER(handle=0,           ---------&gt;
         delivery-id=0, ...)
{ AmqpValue( Declare() ) }

                             &lt;--------- DISPOSITION(first=0, last=0,
                                                    state=Declared(txn-id=0) )


TRANSFER(handle=1,           ---------&gt;
         delivery-id=1,
         state=
           TransactionalState(
             txn-id=0) )
{ ... payload ... }

                             &lt;--------- DISPOSITION(first=1, last=1,
                                                    state=TransactionalState(
                                                            txn-id=0,
                                                            outcome=Accepted())
                                                   )

-------------------------------------------------------------------------------

      </td></tr></table><p>
        On receiving a non-settled delivery associated with a live transaction, the transactional
        resource MUST inform the controller of the presumptive terminal outcome before it can
        successfully discharge the transaction. That is, the resource MUST send a <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-disposition">disposition</a> performative which covers the posted transfer with the state of the
        delivery being a <a href="#type-transactional-state">transactional-state</a> with the correct transaction identified,
        and a terminal outcome. This informs the controller of the outcome that will be in effect at
        the point that the transaction is successfully discharged.
      </p></div><h3><a class="toc" href="#toc">←</a>4.4.2 <a name="doc-idp120240">Transactional Retirement</a></h3><div class="doc"><p>
        The transaction controller might wish to associate the outcome of a delivery with a
        transaction. The delivery itself need not be associated with the same transaction as the
        outcome, or indeed with any transaction at all. However, the delivery MUST NOT be associated
        with a different non-discharged transaction than the outcome. If this happens then the
        control link MUST be terminated with a <a href="#choice-transaction-error-transaction-rollback">transaction-rollback</a> error.
      </p><p>
        To associate an outcome with a transaction the controller sends a <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-disposition">disposition</a> performative which sets the state of the delivery to a <a href="#type-transactional-state">transactional-state</a> with the desired transaction identifier and the outcome to be
        applied upon a successful discharge.
      </p><table class="pre" summary="Transactional Receive"><caption style="caption-side:bottom">Figure 4.4: Transactional Receive</caption><tr><td>
Transaction Controller                  Transactional Resource
===============================================================================

TRANSFER(handle=0,           ---------&gt;
         delivery-id=0, ...)
{ AmqpValue( Declare() ) }

                             &lt;--------- DISPOSITION(first=0, last=0,
                                                    state=Declared(txn-id=0) )
FLOW(handle=2,               ---------&gt;
     link-credit=10)

                             &lt;--------- TRANSFER(handle=2,
                                                 delivery-id=11,
                                                 state=null,
                                        { ... payload ... }

                                  :
                                  :

                             &lt;--------- TRANSFER(handle=2,
                                                 delivery-id=20,
                                                 state=null,
                                        { ... payload ... }


DISPOSITION(first=11,        ---------&gt;
            last=20,
            state=TransactionalState(
                    txn-id=0,
                    outcome=Accepted())
           )

-------------------------------------------------------------------------------

      </td></tr></table><p>
        On a successful <a href="#type-discharge">discharge</a>, the resource will apply the given outcome and can
        immediately settle the transfers. In the event of a controller-initiated rollback (a <a href="#type-discharge">discharge</a> where the fail flag is set to true) or a resource-initiated rollback (the
        <a href="#type-discharge">discharge</a> message being rejected, or the link to the <a href="#type-coordinator">coordinator</a> being detached with an error), the outcome will not be applied, and the
        deliveries will still be "live" and will remain acquired by the controller, i.e., the
        resource can expect the controller to request a disposition for the delivery (either
        transactionally on a new transaction, or non-transactionally).
      </p></div><h3><a class="toc" href="#toc">←</a>4.4.3 <a name="doc-idp130640">Transactional Acquisition</a></h3><div class="doc"><p>
        In the case of the <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-flow">flow</a> frame, the transactional work is not
        necessarily directly initiated or entirely determined when the <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-flow">flow</a> frame arrives at the resource, but can in fact occur at some later point and
        in ways not necessarily anticipated by the controller. To accommodate this, the resource
        associates an additional piece of state with outgoing link endpoints, a <i>txn-id</i> that
        identifies the transaction with which <i>acquired</i> messages will be associated. This
        state is determined by the controller by specifying a <i>txn-id</i> entry in the
        <i>properties</i> map of the flow frame. When a transaction is discharged, the <i>txn-id</i>
        of any link endpoints will be cleared.
      </p><p>
        If the link endpoint does not support transactional acquisition, the link MUST be terminated
        with a <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#choice-amqp-error-not-implemented">not-implemented</a> error.
      </p><p>
        While the <i>txn-id</i> is cleared when the transaction is discharged, this does
        not affect the level of outstanding credit. To prevent the sending link endpoint from
        acquiring outside of any transaction, the <i>controller</i> SHOULD ensure there is no
        outstanding credit at the sender before it discharges the transaction. The <i>controller</i>
        can do this by either setting the drain mode of the sending link endpoint to <i>true</i>
        before discharging the transaction, or by reducing the <i>link-credit</i> to zero, and
        waiting to hear back that the sender has seen this state change.
      </p><p>
        If a transaction is discharged at a point where a message has been transactionally acquired,
        but has not been fully sent (i.e., the delivery of the message will require more than one
        <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-transfer">transfer</a> frame and at least one, but not all, such frames have been sent),
        then the resource MUST interpret this to mean that the fate of the acquisition is fully
        decided by the discharge. If the <a href="#type-discharge">discharge</a> indicates the failure of the
        transaction the resource MUST abort or complete sending the remainder of the message before
        completing the discharge.
      </p><table class="pre" summary="Transactional Acquisition"><caption style="caption-side:bottom">Figure 4.5: Transactional Acquisition</caption><tr><td>
Transaction Controller                  Transactional Resource
===============================================================================

TRANSFER(handle=0,           ---------&gt;
         delivery-id=0, ...)
{ AmqpValue( Declare() ) }

                             &lt;--------- DISPOSITION(first=0, last=0,
                                                    state=Declared(txn-id=0) )
FLOW(handle=2,               ---------&gt;
     link-credit=10,
     drain=true,
     properties={
       txn-id=0
     })

                             &lt;--------- TRANSFER(handle=2,
                                                 delivery-id=11,
                                                 state=
                                                   TransactionalState(txn-id=0),
                                        { ... payload ... }

                                  :
                                  :

                             &lt;--------- TRANSFER(handle=2,
                                                 delivery-id=20,
                                                 state=
                                                   TransactionalState(txn-id=0),
                                        { ... payload ... }


DISPOSITION(first=11,        ---------&gt;
            last=20,
            state=TransactionalState(
                    txn-id=0,
                    outcome=Accepted())
           )

-------------------------------------------------------------------------------

      </td></tr></table></div><h3><a class="toc" href="#toc">←</a>4.4.4 <a name="doc-idp145616">Interaction Of Settlement With Transactions</a></h3><div class="doc"><p>
        The transport layer defines a notion of <i>settlement</i> which refers to the point at which
        the association of a delivery-tag to a delivery attempt is forgotten. Transactions do not in
        themselves change this notion, however the fact that transactional work can be rolled back
        does have implications for deliveries which the endpoint has marked as settled (and for
        which it can therefore no longer exchange state information using the previously allocated
        transport level identifiers).
      </p><h4><a class="toc" href="#toc">←</a><a name="doc-idp147504">Transactional Posting</a></h4><dl>
          <dt>Delivery Sent Settled By Controller</dt>
          <dd><p>The delivered message will not be made available at the node until the transaction
              has been successfully discharged. If the transaction is rolled back then the delivery
              is not made available. If the resource is unable to process the delivery it MUST
              NOT allow the successful discharge of the associated transaction. This can be
              communicated by immediately destroying the controlling link on which the transaction
              was declared, or by rejecting any attempt to discharge the transaction where the fail
              flag is not set to true.
            </p>
          </dd>
          <dt>Delivery Sent Unsettled By Controller; Resource Settles</dt>
          <dd><p>The resource MUST determine the outcome of the delivery before committing the
              transaction, and this MUST be communicated to the controller before the acceptance of
              a successful discharge. The outcome communicated by the resource MUST be associated
              with the same transaction with which the <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-transport-v1.0-os.html#type-transfer">transfer</a> from controller to
              resource was associated.
            </p>
            <p>
              If the transaction is rolled back then the delivery is not made available at the
              target. If the resource can no longer apply the outcome that it originally indicated
              would be the result of a successful discharge then it MUST NOT allow the successful
              discharge of the associated transaction. This can be communicated by immediately
              destroying the controlling link on which the transaction was declared, or by rejecting
              any attempt to discharge the transaction where the fail flag is not set to true.
            </p>
          </dd>
          <dt>Delivery Sent Unsettled By Controller; Resource Does Not Settle</dt>
          <dd><p>Behavior prior to discharge is the same as the previous case.</p>
            <p>
              After a successful discharge, the state of unsettled deliveries at the resource MUST
              reflect the outcome that was applied. If the discharge was unsuccessful then an
              outcome SHOULD NOT be associated with the unsettled deliveries. The controller SHOULD
              settle any outstanding unsettled deliveries in a timely fashion after the transaction
              has discharged.
            </p>
          </dd>
        </dl><h4><a class="toc" href="#toc">←</a><a name="doc-idp31472">Transactional Retirement</a></h4><p>
          This section considers the cases where the resource has sent messages to the controller in
          a non-transactional fashion. For the cases where the resource sends the messages
          transactionally, see <a href="#doc-transactional-acquisition" title="transactional-acquisition">subsection 4.4.3</a>.
        </p><dl>
          <dt>Delivery Sent Unsettled By Resource; Controller Settles</dt>
          <dd><p>Upon a successful discharge the outcome specified by the controller is applied at
              the source. If the controller requests a rollback or the discharge attempt be
              unsuccessful, then the outcome is not applied. At this point the controller can no
              longer influence the state of the delivery as it is settled, and the resource MUST
              apply the default outcome.
            </p>
          </dd>
          <dt>Delivery Sent Unsettled By Resource; Controller Does Not Settle</dt>
          <dd><p>The resource might or might not settle the delivery before the transaction is
              discharged. If the resource settles the delivery before the discharge then the
              behavior after discharge is the same as the case above.
            </p>
            <p>
              Upon a successful discharge the outcome is applied. Otherwise the state reverts to
              that which occurred before the controller sent its (transactional) disposition. The
              controller is free to update the state using subsequent transactional or
              non-transactional updates.
            </p>
          </dd>
        </dl><h4><a class="toc" href="#toc">←</a><a name="doc-transactional-acquisition">Transactional Acquisition</a></h4><dl>
          <dt>Delivery Sent Settled By Resource</dt>
          <dd><p>In the event of a successful discharge the outcome applies at the resource,
              otherwise the acquisition and outcome are rolled back.
            </p>
          </dd>
          <dt>Delivery Sent Unsettled By Resource; Controller Sends Outcome</dt>
          <dd><p>An outcome sent by the controller before the transaction has discharged MUST
              be associated with the same transaction. In the even of a successful discharge the
              outcome is applied at the source, otherwise both the acquisition and outcome are
              rolled back.
            </p>
          </dd>
        </dl></div></div>

  <h2><a class="toc" href="#toc">←</a>4.5 <a name="section-coordination">Coordination</a></h2><div class="section"><h3><a class="toc" href="#toc">←</a>4.5.1 <a name="type-coordinator">Coordinator</a></h3><p>Target for communicating with a transaction coordinator.</p><table class="signature" summary="@(label)"><tr><td>&lt;type name="coordinator" class="composite" source="list" provides="target"&gt;
    &lt;descriptor name="amqp:coordinator:list" code="0x00000000:0x00000030"/&gt;
    &lt;field name="capabilities" type="symbol" requires="txn-capability" multiple="true"/&gt;
&lt;/type&gt;</td></tr></table><div class="doc"><p>
          The coordinator type defines a special target used for establishing a link with a
          transaction coordinator.
        </p></div><table class="composite" summary="coordinator fields"><tr><td><b>capabilities</b></td><td><i>the capabilities supported at the coordinator</i></td><td>optional <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-types-v1.0-os.html#type-symbol">symbol</a>[]</td></tr><tr><td class="field" colspan="2"><div class="doc"><p>
            When sent by the transaction controller (the sending endpoint), indicates the desired
            capabilities of the coordinator. When sent by the resource (the receiving endpoint),
            defined the actual capabilities of the coordinator. Note that it is the responsibility
            of the transaction controller to verify that the capabilities of the controller meet its
            requirements. See <a href="#type-txn-capability">txn-capability</a>.
        </p></div></td></tr></table><h3><a class="toc" href="#toc">←</a>4.5.2 <a name="type-declare">Declare</a></h3><p>Message body for declaring a transaction id.</p><table class="signature" summary="@(label)"><tr><td>&lt;type name="declare" class="composite" source="list"&gt;
    &lt;descriptor name="amqp:declare:list" code="0x00000000:0x00000031"/&gt;
    &lt;field name="global-id" type="*" requires="global-tx-id"/&gt;
&lt;/type&gt;</td></tr></table><div class="doc"><p>
          The declare type defines the message body sent to the coordinator to declare a
          transaction. The txn-id allocated for this transaction is chosen by the transaction
          controller and identified in the <a href="#type-declared">declared</a> resulting outcome.
        </p></div><table class="composite" summary="declare fields"><tr><td><b>global-id</b></td><td><i>global transaction id</i></td><td>optional *</td></tr><tr><td class="field" colspan="2"><div class="doc"><p>
            Specifies that the txn-id allocated by this declare MUST be associated with the
            indicated global transaction. If not set, the allocated txn-id will be associated with a
            local transaction. This field MUST NOT be set if the coordinator does not have the <a href="#choice-txn-capability-distributed-transactions">distributed-transactions</a> capability. Note that the
            details of distributed transactions within AMQP 1.0 will be provided in a separate
            specification.
          </p></div></td></tr></table><h3><a class="toc" href="#toc">←</a>4.5.3 <a name="type-discharge">Discharge</a></h3><p>Message body for discharging a transaction.</p><table class="signature" summary="@(label)"><tr><td>&lt;type name="discharge" class="composite" source="list"&gt;
    &lt;descriptor name="amqp:discharge:list" code="0x00000000:0x00000032"/&gt;
    &lt;field name="txn-id" type="*" requires="txn-id" mandatory="true"/&gt;
    &lt;field name="fail" type="boolean"/&gt;
&lt;/type&gt;</td></tr></table><div class="doc"><p>
          The discharge type defines the message body sent to the coordinator to indicate that the
          txn-id is no longer in use. If the transaction is not associated with a global-id, then
          this also indicates the disposition of the local transaction.
        </p></div><table class="composite" summary="discharge fields"><tr><td><b>txn-id</b></td><td><i>identifies the transaction to be discharged</i></td><td>mandatory *</td></tr><tr><td class="field" colspan="2"></td></tr><tr><td><b>fail</b></td><td><i>indicates the transaction has failed</i></td><td>optional <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-types-v1.0-os.html#type-boolean">boolean</a></td></tr><tr><td class="field" colspan="2"><div class="doc"><p>
            If set, this flag indicates that the work associated with this transaction has failed,
            and the controller wishes the transaction to be rolled back. If the transaction is
            associated with a global-id this will render the global transaction rollback-only. If
            the transaction is a local transaction, then this flag controls whether the transaction
            is committed or aborted when it is discharged. (Note that the specification for
            distributed transactions within AMQP 1.0 will be provided separately in Part 6
            Distributed Transactions).
          </p></div></td></tr></table><h3><a class="toc" href="#toc">←</a>4.5.4 <a name="type-transaction-id">Transaction Id</a></h3><table class="signature" summary="@(label)"><tr><td>&lt;type name="transaction-id" class="restricted" source="binary" provides="txn-id"/&gt;</td></tr></table><div class="doc"><p>
          A transaction-id can be up to 32 octets of binary data.
        </p></div><table class="composite" summary="possible values"></table><h3><a class="toc" href="#toc">←</a>4.5.5 <a name="type-declared">Declared</a></h3><table class="signature" summary="@(label)"><tr><td>&lt;type name="declared" class="composite" source="list" provides="delivery-state, outcome"&gt;
    &lt;descriptor name="amqp:declared:list" code="0x00000000:0x00000033"/&gt;
    &lt;field name="txn-id" type="*" requires="txn-id" mandatory="true"/&gt;
&lt;/type&gt;</td></tr></table><div class="doc"><p>
          Indicates that a transaction identifier has successfully been allocated in response to a
          declare message sent to a transaction coordinator.
        </p></div><table class="composite" summary="declared fields"><tr><td><b>txn-id</b></td><td><i>the allocated transaction id</i></td><td>mandatory *</td></tr><tr><td class="field" colspan="2"></td></tr></table><h3><a class="toc" href="#toc">←</a>4.5.6 <a name="type-transactional-state">Transactional State</a></h3><p>The state of a transactional message transfer.</p><table class="signature" summary="@(label)"><tr><td>&lt;type name="transactional-state" class="composite" source="list" provides="delivery-state"&gt;
    &lt;descriptor name="amqp:transactional-state:list" code="0x00000000:0x00000034"/&gt;
    &lt;field name="txn-id" type="*" mandatory="true" requires="txn-id"/&gt;
    &lt;field name="outcome" type="*" requires="outcome"/&gt;
&lt;/type&gt;</td></tr></table><div class="doc"><p>
          The transactional-state type defines a delivery-state that is used to associate a delivery
          with a transaction as well as to indicate which outcome is to be applied if the
          transaction commits.
        </p></div><table class="composite" summary="transactional-state fields"><tr><td><b>txn-id</b></td><td><i>identifies the transaction with which the state is associated</i></td><td>mandatory *</td></tr><tr><td class="field" colspan="2"></td></tr><tr><td><b>outcome</b></td><td><i>provisional outcome</i></td><td>optional *</td></tr><tr><td class="field" colspan="2"><div class="doc"><p>
            This field indicates the provisional outcome to be applied if the transaction commits.
          </p></div></td></tr></table><h3><a class="toc" href="#toc">←</a>4.5.7 <a name="type-txn-capability">Txn Capability</a></h3><p>Symbols indicating (desired/available) capabilities of a transaction coordinator.</p><table class="signature" summary="@(label)"><tr><td>&lt;type name="txn-capability" class="restricted" source="symbol" provides="txn-capability"&gt;
    &lt;choice name="local-transactions" value="amqp:local-transactions"/&gt;
    &lt;choice name="distributed-transactions" value="amqp:distributed-transactions"/&gt;
    &lt;choice name="promotable-transactions" value="amqp:promotable-transactions"/&gt;
    &lt;choice name="multi-txns-per-ssn" value="amqp:multi-txns-per-ssn"/&gt;
    &lt;choice name="multi-ssns-per-txn" value="amqp:multi-ssns-per-txn"/&gt;
&lt;/type&gt;</td></tr></table><table class="composite" summary="possible values"><tr><td><b><a class="anchor" name="choice-txn-capability-local-transactions">local-transactions</a></b></td><td></td><td>amqp:local-transactions</td></tr><tr><td class="field" colspan="2"><div class="doc"><p>
              Support local transactions.
          </p></div></td></tr><tr><td><b><a class="anchor" name="choice-txn-capability-distributed-transactions">distributed-transactions</a></b></td><td></td><td>amqp:distributed-transactions</td></tr><tr><td class="field" colspan="2"><div class="doc"><p>
              Support AMQP Distributed Transactions.
          </p></div></td></tr><tr><td><b><a class="anchor" name="choice-txn-capability-promotable-transactions">promotable-transactions</a></b></td><td></td><td>amqp:promotable-transactions</td></tr><tr><td class="field" colspan="2"><div class="doc"><p>
              Support AMQP Promotable Transactions.
          </p></div></td></tr><tr><td><b><a class="anchor" name="choice-txn-capability-multi-txns-per-ssn">multi-txns-per-ssn</a></b></td><td></td><td>amqp:multi-txns-per-ssn</td></tr><tr><td class="field" colspan="2"><div class="doc"><p>
              Support multiple active transactions on a single session.
          </p></div></td></tr><tr><td><b><a class="anchor" name="choice-txn-capability-multi-ssns-per-txn">multi-ssns-per-txn</a></b></td><td></td><td>amqp:multi-ssns-per-txn</td></tr><tr><td class="field" colspan="2"><div class="doc"><p>
              Support transactions whose txn-id is used across sessions on one connection.
          </p></div></td></tr></table><h3><a class="toc" href="#toc">←</a>4.5.8 <a name="type-transaction-error">Transaction Error</a></h3><p>Symbols used to indicate transaction errors.</p><table class="signature" summary="@(label)"><tr><td>&lt;type name="transaction-error" class="restricted" source="symbol" provides="error-condition"&gt;
    &lt;choice name="unknown-id" value="amqp:transaction:unknown-id"/&gt;
    &lt;choice name="transaction-rollback" value="amqp:transaction:rollback"/&gt;
    &lt;choice name="transaction-timeout" value="amqp:transaction:timeout"/&gt;
&lt;/type&gt;</td></tr></table><table class="composite" summary="possible values"><tr><td><b><a class="anchor" name="choice-transaction-error-unknown-id">unknown-id</a></b></td><td></td><td>amqp:transaction:unknown-id</td></tr><tr><td class="field" colspan="2"><div class="doc"><p>The specified txn-id does not exist.</p></div></td></tr><tr><td><b><a class="anchor" name="choice-transaction-error-transaction-rollback">transaction-rollback</a></b></td><td></td><td>amqp:transaction:rollback</td></tr><tr><td class="field" colspan="2"><div class="doc"><p>The transaction was rolled back for an unspecified reason.</p></div></td></tr><tr><td><b><a class="anchor" name="choice-transaction-error-transaction-timeout">transaction-timeout</a></b></td><td></td><td>amqp:transaction:timeout</td></tr><tr><td class="field" colspan="2"><div class="doc"><p>The work represented by this transaction took too long.</p></div></td></tr></table></div>

<hr><table width="100%" class="partNav" border="0"><tr><td width="50%" align="left"><a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-messaging-v1.0-os.html#toc">&lt;&lt; Part 3: Messaging</a></td><td width="50%" align="right"><a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-security-v1.0-os.html#toc">
          Part 5: Security &gt;&gt;
        </a></td></tr></table></body></html>
